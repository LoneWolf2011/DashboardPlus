<?php	require ROOT_PATH.$root_file['phpmailer'];		$clean_ini 		= preg_replace("/[^a-zA-Z]/", "", $_POST['Initialen'] );	$cleaned_ini 	= strtoupper($clean_ini); 	    if(!empty($_POST['request']) && hash_equals($_POST['csrf'],$_SESSION['db_token']))	{	        $query = "             SELECT                 id,				Initialen,				Voornaam,				Achternaam,				email            FROM users             WHERE                 Initialen = :Initialen 			LIMIT 1        ";                  $query_params = array(             ':Initialen' => $cleaned_ini         );                  try         {             $stmt 	= $db->prepare($query);             $result = $stmt->execute($query_params);         }         catch(PDOException $ex)         { 			$msg = 'Regel: ' . $ex->getLine().' Bestand: ' . $ex->getFile().' Error: ' . $ex->getMessage();			logToFile(__FILE__,1,$msg);            die("Error logged to file!");         }          $user_auth = FALSE;         $row = $stmt->fetch(); 		        if($row){ 			$user_auth = TRUE; 		} else {			die(header("Location: ../index.php?uknw=".$cleaned_ini));					}		        if($user_auth) {  			// Generate random token			$token 		= openssl_random_pseudo_bytes(32);			$token 		= bin2hex($token);					$salt 		= dechex(mt_rand(0, 2147483647)) . dechex(mt_rand(0, 2147483647)); 				$token_hash = hash('sha256', $token . $salt); 				for($round 	= 0; $round < 65536; $round++){ 				$token_hash = hash('sha256', $token_hash . $salt); 			} 								$query = " 				INSERT INTO users_tokens ( 					user_ini, 					date_time, 					date_request, 					token_hash,					token_salt									) VALUES ( 					:user_ini, 					:date_time, 					:date_request, 					:token_hash, 					:token_salt 				) 			"; 						$query_params = array( 				':user_ini' 	=> $cleaned_ini, 				':date_time' 	=> time(),				':date_request' => date("Y-m-d H:i:s"), 				':token_hash' 	=> $token_hash,				':token_salt' 	=> $salt			); 				try 			{ 				$stmt	= $db->prepare($query); 				$result = $stmt->execute($query_params);								// Log to file				$msg = "Token request voor user ". $cleaned_ini." aangevraagd";				logToFile(__FILE__,0,$msg);						} 			catch(PDOException $ex) 			{ 							$msg = 'Regel: ' . $ex->getLine().' Bestand: ' . $ex->getFile().' Error: ' . $ex->getMessage();				logToFile(__FILE__,1,$msg);				die("Error logged to file!"); 			} 				// Enkel voor testing			//die(header("Location: ../token.php?rec=".$token."&id=".$row['Initialen']));						$message = '<body>';			$message .= '<table border="0" style=" border-color: #fff; width: 500px;" cellpadding="5">';					$message .= "<th colspan='2' style='border-bottom: 1px solid #9CD4F6;'><img src='".URL_ROOT_IMG."ASB.png' alt='ASB security' style='float: left;'/></th>"; 					$message .= "<tr><td colspan='2'>Beste " .$row['Voornaam']." ".$row['Achternaam'].",</td></tr>";			$message .= "<tr><td colspan='2'>Open de onderstaande link om je wachtwoord te resetten.</td></tr>";			$message .= "<tr><td colspan='2'>Heb jij geen aanvraag gedaan. Klik dan niet op de link! De link vervalt automatisch na 10 minuten.</td></tr>";						$message .= "<tr><td colspan='2'><a class='link' href='".URL_ROOT."token.php?rec=".$token."&id=".$row['Initialen']."'>Recover token</a></td></tr>";			$message .= "</table>";			$message .= "</body>";			$mail = new PHPmailer();						$mail -> AddAddress($row['email']);				$mail -> SetFrom(APP_EMAIL);			$mail -> Subject = "Paperless Office wachtwoord token (1/2)";			$mail -> MsgHTML($message);			$mail -> WordWrap = 80;						if($mail->Send()) {					die(header("Location: ../index.php?tok=suc"));			} else {				die(header("Location: ../index.php?tok=err"));			}								} else {			die(header("Location: ../index.php?uknw=".$cleaned_ini));					}    } else {		// Log to file		$msg = "CSRF token invalid during token generate for user: ". $_POST['email'];		logToFile(__FILE__,0,$msg);		header("Location: ".URL_ROOT);		die("Redirecting to: ".URL_ROOT);				}